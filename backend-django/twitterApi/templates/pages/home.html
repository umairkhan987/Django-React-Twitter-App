{% extends 'base.html' %}

{% block content %}
    <div class="row text-center">
        <div class="col">
            <h1>Welcome to tweet me!</h1>
        </div>
    </div>

    {#  tweet form   #}
    <div class="row mb-3">
        <div class="col-md-4 mx-auto col-10">
            <form class="form" id="tweet-create-from" action="/create-tweet" method="post">
                {% csrf_token %}
                <div class="d-none alert alert-danger" id="create-tweet-form-error"></div>
                <input type="hidden" value="/" name="next">
                <textarea required="required" class="form-control" name="content" placeholder="share your thought"></textarea>
                <button type="submit" class="btn btn-primary mt-1">Tweet</button>
            </form>
        </div>
    </div>

    <div class="row" id="tweets">
        Loading....
    </div>

    <script>
        const tweetsEl = document.getElementById("tweets");
        const tweetCreateFromEl = document.getElementById("tweet-create-from");

        tweetCreateFromEl.addEventListener("submit", function (event) {
            event.preventDefault();
            const myform = event.target;
            const myFormData = new FormData(myform);
            const url = myform.getAttribute("action");
            const method = myform.getAttribute("method");

            const xhr = new XMLHttpRequest();
            xhr.responseType = "json";
            xhr.open(method, url);
            xhr.setRequestHeader("HTTP_X_REQUESTED_WITH", "XMLHttpRequest");
            xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
            xhr.onload = function () {
                if(xhr.status === 201){
                    handleTweetFormError("", false);
                    const newTweetJson = xhr.response;
                    const newTweetElement = formatTweetElement(newTweetJson);
                    const ogHtml = tweetsEl.innerHTML;
                    tweetsEl.innerHTML = newTweetElement + ogHtml;
                    myform.reset();
                }
                else if (xhr.status === 400){
                    const errorJson = xhr.response;
                    const contentError = errorJson.content;
                    if(contentError){
                        let contentErrorMsg = contentError[0];
                        if(contentErrorMsg){
                            handleTweetFormError(contentErrorMsg, true);
                        }else{
                            alert("An error has occurred, please try again latter")
                        }
                    }
                }
                else if(xhr.status === 401){
                    alert("You must login.");
                    window.location.href = "/login";
                }
                else if (xhr.status === 500){
                    alert("There is server error, please try again latter");
                }
            };
            xhr.onerror = function(){
                alert("An error occurred. please try again latter.");
            };
            xhr.send(myFormData);
        });

        function loadTweet(tweetElement) {
            const xhr = new XMLHttpRequest();
            const method = "Get";
            const url = "/tweets";

            xhr.responseType = "json";
            xhr.open(method, url);
            xhr.onload = function () {
                const listedItem = xhr.response.response;
                let finalTweetStr = "";
                for (let i = 0; i < listedItem.length; i++) {
                    let currentItem = formatTweetElement(listedItem[i]);
                        finalTweetStr += currentItem;
                }
                tweetElement.innerHTML = finalTweetStr;
            };
            xhr.send();
        }

        loadTweet(tweetsEl);

        function handleTweetFormError(msg,display) {
            const errorDivElement = document.getElementById("create-tweet-form-error");
            if(display === true){
                errorDivElement.setAttribute("class", "d-block alert alert-danger");
                errorDivElement.innerText = msg;
            }else{
                errorDivElement.setAttribute("class", "d-none alert alert-danger");
            }
        }

        function handleLike(tweet_id, currentCount) {
            console.log("id = " + tweet_id);
            console.log("Total like = " + currentCount);
        }

        function LikeBtn(tweet) {
            return "<button class='btn btn-primary' onclick='handleLike(" + tweet.id + "," + tweet.likes + ")'><span class='small'>" + tweet.likes + "</span>  Like</button>";
        }

        function formatTweetElement(tweet) {
            return "<div class='col-12 col-md-10 mx-auto border rounded py-3 mb-4 tweet-" + tweet.id + "'> " +
                "<p> " + tweet.content + "</p> " +
                "<div class='btn-group'>" + LikeBtn(tweet) + "</div></div>";
        }
    </script>
{% endblock %}